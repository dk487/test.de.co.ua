---
title: Запуск Mosquitto та Node-RED
date: 2022-11-14 15:04:43 +02:00
---

Я так подумав: раз в мене вже тут вийшов у [попередньому пості][1] такий собі лікнеп для чайників, то треба розповісти останні деталі, а саме про Mosquitto та Node-RED.


## Що це все таке

MQTT — це стандарт де-факто на комунікацію між пристроями в IoT.

Брокер MQTT просто приймає від клієнтів повідомлення і відправляє їх іншим клієнтам-підписникам. Це дуже схоже на IRC, тільки сервер тут зветься «брокер», а про канал кажуть «топік». Існують різні брокери, та майже завжди йдеться про Mosquitto.

Node-RED це така своєрідна платформа, яка підходить для поєднання всякої низькорівневої хріні з усякою іншою низькорівневою хрінню: MQTT, бази даних, REST API, скрипти.


## Запуск

Mosquitto в Debian та Ubuntu можна поставити просто з репозиторію (десь у мене так і є), але зазвичай мені буває зручно запускати його через Docker Compose разом з Node-RED.

### `docker-compose.yml`

```yaml
version: '3'

services:
  mqtt:
    image: eclipse-mosquitto
    ports:
      - 1883:1883
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  nodered:
    image: nodered/node-red
    ports:
      - 1880:1880
    volumes:
      - ./node-red-data:/data
    links:
      - mqtt
```

Як видно з цього файлу, тут ще треба зробити підкаталог `node-red-data`, у якому зберігатимуться всі нутрощі Node-RED, та конфіг Mosquitto.

### `mosquitto.conf`

```
allow_anonymous true

listener 1883
```

Ну і все, можна запускати `docker-compose up` і все має запуститися.


## Приклад використання Node-RED

Node-RED після запуску з дефолтними налаштуваннями доступна за адресою <u>http://localhost:1880/</u> і не потребує паролю.

> The S in IoT Stands for Security

Насправді тут можна і пароль зробити, і різні види аутентифікації прикрутити десь на reverse proxy, але ж ми просто граємося і блимаємо світлодіодом.

![Знімок екрану: порожня чиста нова Node-RED](/uploads/nodered_new.png)

Так, що ще треба. В головному меню Node-RED (правий верхній кут, три рисочки) треба зайти в `Manage palette` (це типу як пакетний менеджер) та встановити модуль `node-red-dashboard`. Навіть не знаю, чому він не входить до стандартного комплекту.

Нам треба додати на наш flow два вузли з групи network, а саме `mqtt in` та `mqtt out`. Також нам треба вузол `switch` з групи dashboard. От я їх просто перетягнув кудись і ще не сконфігурував.

![Знімок екрану: три несконфігурованих вузла Node-RED](/uploads/nodered_new_3_nodes.png)

Двічі клацніть на вузол `mqtt in`. Відкриється вікно редагування. Нам треба налаштувати сервер та топік. Сервер ми ще жоден не налаштовували, тому треба його створити; достатньо вказати хост `mqtt` (не 127.0.0.1, а ім'я хосту з Docker Compose) і все інше лишити як є. Топік для вхідних повідомлень на цьому вузлі має бути `board01/led`.

Аналогічним чином конфігуруємо вузол `mqtt out`. Тільки топік там має бути `board01/led/set`, а раніше сконфігурований сервер вже буде вказано за замовчанням.

Тепер вузол `switch`. Треба створити групу (стовпчик, де він має відображатися), при створенні групи треба буде створити нову dashboard tab (сторінку, де воно все буде). Якщо нічого не міняти, то зі значеннями по замовченню у вас створиться tab з назвою Home та група Default.

Далі трошки неочевидне. Треба визначити, які значення відповідають стану «увімкнено» і що вважається станом «вимкнено» (On Payload та Off Payload, відповідно). Встановіть для обох тип number. Значення 1 та 0, відповідно.

Наостанок, встановіть йому якийсь зрозумілий label. Наприклад «LED».

![Знімок екрану: конфігурація вузла switch в Node-RED](/uploads/nodered_switch.png)

Тепер лишається поєднати мишкою всі три вузли та натиснути на Deploy.

![Знімок екрану: три з'єднанних вузла Node-RED](/uploads/nodered_connected_3_nodes.png)

Все! Dashboard знаходиться за адресою <u>http://127.0.0.1:1880/ui/</u> (теж без паролю).

![Знімок екрану: Node-RED dashboard з одним вимикачем](/uploads/nodered_new_dashboard.png)

Якщо все вийшло правильно, то цей перемикач буде вмикати-вимикати світлодіод на платі NodeMCU з попереднього поста.

Вхідні повідомлення з топіку `board01/led` змінюють стан перемикача. Зміна стану перемикача (будь-яка) призводить до надсилання вихідного повідомлення до топуку `board01/led/set`. Дещо неефективно, та йой, най буде. Краще було б не надсилати до MQTT повідомлення про ту зміну стану, яка і так є реакцією на MQTT, але я поки не знаю, як це зробити просто і елегантно.


## Тестування dasboard'у

Не завжди все виходить правильно з першого разу.

Для відлагодження та для експериментів з MQTT варто встановити пакет `mosquitto-clients`, навіть якщо у вас Mosquitto тільки в Docker'і.

Зокрема, так я дивлюся, що відбувається на всіх топіках (wildcard `#`):

```sh
mosquitto_sub -h 127.0.0.1 -t "#" -v
```

Цей `mosquitto_sub` працює як `tail -f`, для його зупинки треба <kbd>Ctrl</kbd>&nbsp;<kbd>C</kbd>. Коли ви натискаєте на перемикач, мають з'являтися нові повідомлення з топіком `board01/led/set`.

А ось так я вручну відправляю повідомлення з текстом `1` на топік `board01/led`, імітуючи повідомлення від NodeMCU:

```sh
mosquitto_pub -t board01/led -m 1
```

Ну, в принципі, і все. Отака фігня.

[1]: /2022/11/14/micropython-on-esp8266.html
