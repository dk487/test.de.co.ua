---
title: <code>make mtime</code>
title_lang: en
date: 2023-01-14 18:46:01 +02:00
mtime: 2023-01-15 04:05:43 +02:00
---

Запиляв собі [стрьомну автоматизацію][1] для кращого контролю за датою оновлення публікацій.

Можливо, через пару днів подивлюся на це все і вирішу, що то є стрьомна чортівня. Але поки мені подобається і поки я ~~в цій схемі не бачу явних вад~~.
_Оновлено:_ ну, точніше, це краще ніж нічого.


Про що мова
-----------

Цілком природньо, що у кожної сторінки (в даному випадку у кожного посту) є _дата створення_, тобто момент часу, коли пост був створений чи опублікований (вважатимемо це одним і тим же). Це те, що Jekyll очікує побачити у полі `date` десь у <span lang="en">front matter</span>.

Але, також цілком природньо, кожну сторінку я можу оновити: виправити помилки, дописати постскриптум, або типова для цього блоґа фішка — послухати, як ця сторінка звучить через синтез мовлення, і додати наголоси. І це буде _дата останньої модифікації_. Стандартного такого поля у Jekyll не передбачено. Я вирішив назвати це поле `mtime`.

Обидві дати важливі. Обидві дати потрібні. В хронологічному порядку постів (і навіть в URL) використовується дата створення. Але в RSS/Atom та в sitemap треба використовувати дату останнього оновлення.


Як воно працює
--------------

Задум такий. Команда `make post_checkout` оновлює дату останньої модифікації файлу (тобто у файловій системі) у відповідності до моменту часу останнього комміту в цей файл, крім тих коммітів, у яких <span lang="en">commit message</span> співпадає зі спеціальною магічною константою `Fix mtime`.

Далі. Команда `make mtime` оновлює поле `mtime` (або створює його) у <span lang="en">front matter</span> до значення, що співпадає з датою останньої модифікації файлу.


Що не працює
------------

Ще не придумав, як краще зробити синхронізацію дати комміта і значення поля `mtime` всередині файлу. Ну, завжди можна зробити два комміта: один який треба, другий `Fix mtime`, хоч це і тупо. Але, можливо, краще `mtime` оновлювати через <span lang="en">pre-commit hook</span>.
_Оновлено:_ або спробую міняти дату комміту на потрібну через `git commit --amend`.

```sh
git commit --amend --date "`git diff HEAD^ HEAD | grep '^+mtime:' | cut -c9-`"
```

Можливо, мій [інструмент для публікації][2] варто трохи поліпшити, щоб він робив `git commit --date="..."` для кожного нового посту. Треба виключити ризик виникнення ситуацій, коли дата поста і дата комміта відрізняються на одну-дві секунду.
_Оновлено:_ як тимчасовий <span lang="en">workaround</span>, я десь в шаблонах місцями ігнорую `mtime`, що відрізняється від дати створення менш ніж на годину.

А от команда `make post` працює інакше, вона створює шаблон з вже вказаною датою. Потім я в цей шаблон додаю свій текст, а дата лишається старою. Можливо, тут треба додаткову автоматизацію — наприклад таку, яка вже є в `make pub`. Зараз я оновлю дату вручну і зроблю комміт з ключем `--date="..."`, але це криво.

Далі буде.


[1]: https://github.com/dk487/test.de.co.ua/commit/ca003359329930362fe21ba54fa9143a150bc58b
[2]: /2022/07/12/instrument-dlia-postynhu.html
