---
title: OpenGraph bad magic
title_lang: en
date: 2023-11-28 04:43:23 +02:00
mtime: 2023-12-05 12:55:41 +02:00
opegraph_generator:
  template: clickbait01
  label_row1: Погана магія
  label_row2: OpenGraph
  key_color: ff0
---

Намагаюся зробити одну дуже збочену фігню́. Так, поди́вимось…

Я рік тому зробив [мінімальну підтримку][1] OpenGraph. Відто́ді всі пости мають якусь заставку «за замо́вчанням». Це добре, але мало.

В деяких постах я руками вказую окрему картинку, і це зазвичай непогано. Це буває в постах, де вже і так є якісь зображення. Наприклад, [ось тут є знімок екрану][2], і я в тому пості́ використовую для заставки OpenGraph зображення, згенеро́ване зі знімку екрану (відмасштабо́ване і обрі́зане до стандартного розміру 1200×630). Це все трохи незручно, але воно того варте.

Але що робити для пості́в без картинок? Іноді хочеться щось утну́ти.

Хочеться написати у <span lang="en">front matter</span> поста якусь фігню́, типу такого:

```yaml
opegraph_generator:
  template: clickbait01.svg
  label_row1: Погана магія
  label_row2: OpenGraph
  key_color: ff0
```

…і щоб далі Jekyll та Makefile та мої скрипти магічним чином з шаблона і цих змінних створили файл, скажімо, [`opengraph/_svg/2023-11-28-opengraph-bad-magic.svg`][3] (далі вже просто). Ви ж в курсі, шаблони ж не тільки для <abbr>HTML</abbr>? Ними можна генерувати будь-що текстове — <abbr>RSS</abbr>, <abbr>JSON</abbr>, можна і <abbr>SVG</abbr>.

Але я поки не придумав, як би це зробити. Зокрема, велике западло́ у тому, що все що робе Jekyll потрапляє у вихідний підката́лог `_site`, а це зовсім не те що треба.

_Оновлення від 30 листопада:_ наче щось придумав!


## Три різних Jekyll'а

Це серйозне збочення, але я щось придумав.

Так от. У мене є нормальний [`_config.yml`][4]. З ним все добре, нічого не міняється, він використовується для збірки сайту командою `jekyll build` і саме з ним працюватиме GitHub Pages.

А додатково є два інших конфігураційних файли Jekyll'а, [`_og_prepare.yml`][5] та [`_og_generate.yml`][6] для двоета́пної генерації <abbr>SVG</abbr>. Це тепер робиться командою `make badmagic`.


### Етап 1 з 2: підготовка

[Перетво́рюємо Markdown в Markdown!][7]

На цьому етапі з усіх пості́в сайту створюються відповідні їм вихідні файли у `opengraph/_tmp`.

При цьому відтворюється іменування джерельних файлів Jekyll'а. Зокрема, з поточної сторінки генерується файл з іменем `/opengraph/_tmp/2023-11-28-opengraph-bad-magic.md` з отаким <span lang="en">front matter</span>:

```yaml
permalink: '2023-11-28-opengraph-bad-magic.svg'
layout: og_clickbait01.svg
label_row1: Погана магія
label_row2: OpenGraph
key_color: ff0
```

Секції з контентом немає, тільки <span lang="en">front matter</span>. Нам цього цілком і повністю має вистачити, щоб згенерувати <abbr>SVG</abbr> на наступному етапі.

Для інших сторінок (тобто тих, у яких немає `opegraph_generator`) генерується якась тупа заглушка.


### Етап 2 з 2: генерація

Хоч дуже збочено, але ми зібрали все що треба на попередньому етапі. Далі все просто:
[перетво́рюємо Markdown в SVG][8].


### Етап 3 з 2: конвертація <abbr>SVG</abbr> в <abbr>PNG</abbr>

Це у мене і так робиться при кожному запуску `make`. Я тільки додав спеціальні правила для обробки підкаталога `opengraph/_svg`.

Така особливість мого сайту, що результу́ючі сконвертовані картинки я додаю́ в свій репозиторій. Так, їх можна згенерувати знову, якщо зміниться першоджерело. Так, я в репозито́рії поруч з джерелом зберіга́ю згенерований біна́рнік. Це не дуже красиво, але зручно. Я колись давно став так робити [для іко́нки сайту][9] і, в принципі, мене не сильно бісить.

Так. Ладно. Все похуй.

**Воно працює!**

[1]: /2022/07/16/opengraph-image.html
[2]: /2023/10/16/hello-kubuntu.html
[3]: https://github.com/dk487/test.de.co.ua/blob/master/opengraph/_svg/2023-11-28-opengraph-bad-magic.svg
[4]: https://github.com/dk487/test.de.co.ua/blob/master/_config.yml
[5]: https://github.com/dk487/test.de.co.ua/blob/master/_og_prepare.yml
[6]: https://github.com/dk487/test.de.co.ua/blob/master/_og_generate.yml
[7]: https://github.com/dk487/test.de.co.ua/blob/master/_layouts/og_prepare.md?plain=1
[8]: https://github.com/dk487/test.de.co.ua/blob/master/_layouts/og_clickbait01.svg?short_path=b70fd43
[9]: /2021/10/08/icons.html
